# セキュリティ設定ドキュメント

## 環境変数（.env）ファイルの保護

本プロジェクトでは、以下の多層防御アプローチで環境変数ファイルを保護しています。

### 1. ファイルシステムレベルの保護

#### 1.1 ファイル権限の設定
```bash
chmod 600 .env  # 所有者のみ読み書き可能
```

#### 1.2 .gitignoreによる除外
- `.env`ファイルおよび関連ファイルはGitリポジトリから除外
- `.env.local`, `.env.production`なども同様に除外

### 2. Webサーバーレベルの保護

#### 2.1 .htaccessファイル
プロジェクトルートおよびbackendディレクトリに`.htaccess`ファイルを配置：

```apache
# .envファイルへの直接アクセスを完全にブロック
<Files ~ "^\.env">
    Order allow,deny
    Deny from all
</Files>

# 環境変数ファイルのパターンをブロック
<FilesMatch "\.(env|env\..*|.*\.env)$">
    Order allow,deny
    Deny from all
</FilesMatch>
```

### 3. アプリケーションレベルの保護

#### 3.1 セキュリティミドルウェア
`security_middleware.py`により以下を実装：

- **パスセキュリティチェック**: 危険なパターンの検出とブロック
- **ディレクトリトラバーサル対策**: `../`や`%2e%2e`などの攻撃を防御
- **レート制限**: 過度なリクエストの制限
- **APIキー検証**: 認証されたアクセスのみ許可

#### 3.2 静的ファイル配信の制限
`file_security.py`により以下を実装：

- ブロックすべきファイル名パターンの定義
- ブロックすべきディレクトリの定義
- MIMEタイプの確認と実行可能ファイルのブロック

### 4. 環境変数の暗号化

#### 4.1 暗号化管理システム
`env_encryption.py`により以下を実装：

- **暗号化**: Fernetアルゴリズムによる環境変数の暗号化
- **鍵管理**: PBKDF2による安全な鍵導出
- **ハッシュ検証**: APIキーのハッシュ比較による検証

#### 4.2 暗号化された環境変数の使用
```python
from env_encryption import secure_getenv

# セキュアに環境変数を取得
api_key = secure_getenv('CLAUDE_API_KEY')
```

### 5. セキュリティヘッダー

レスポンスに以下のセキュリティヘッダーを追加：

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Content-Security-Policy: default-src 'self'`
- `Strict-Transport-Security: max-age=31536000`

## セキュリティテストの実行

### テストスクリプトの実行方法

```bash
# バックエンドサーバーを起動
cd setting/backend
python3 app.py

# 別のターミナルでテストを実行
python3 security_test.py
```

### テスト項目

1. **直接アクセステスト**
   - `/.env`へのアクセス試行
   - `/setting/backend/.env`へのアクセス試行

2. **ディレクトリトラバーサル攻撃テスト**
   - `/../.env`
   - `/%2e%2e/.env`

3. **URLエンコード攻撃テスト**
   - `/%2e%65%6e%76` (.env)

4. **APIセキュリティテスト**
   - 不正なパラメータでのAPIアクセス

## 推奨事項

### 本番環境での追加設定

1. **環境変数の管理**
   - 本番環境では環境変数管理サービス（AWS Secrets Manager、HashiCorp Vault等）の使用を推奨
   - `.env`ファイルではなく、システム環境変数として設定

2. **HTTPS通信の強制**
   - SSL/TLS証明書の設定
   - HTTPからHTTPSへのリダイレクト

3. **ファイアウォール設定**
   - 不要なポートを閉じる
   - IP制限の実装

4. **監査ログ**
   - すべてのアクセス試行をログに記録
   - 異常なアクセスパターンの検出

5. **定期的なセキュリティ更新**
   - 依存関係の定期的な更新
   - セキュリティパッチの適用

## インシデント対応

環境変数の漏洩が疑われる場合：

1. **即座の対応**
   - 影響を受けたAPIキーの無効化
   - 新しいAPIキーの生成と更新

2. **調査**
   - アクセスログの確認
   - 不正アクセスの範囲特定

3. **対策**
   - セキュリティ設定の見直し
   - 追加のセキュリティ層の実装

## 連絡先

セキュリティ問題を発見した場合は、公開せずに以下に連絡してください：
- セキュリティチーム: security@example.com